<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum News Hub - AI-Powered News & Ecosystems Ontology</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- D3.js for ontology visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        :root {
            --quantum-primary: #6366f1;
            --quantum-secondary: #8b5cf6;
            --quantum-accent: #06b6d4;
            --quantum-dark: #1e293b;
            --quantum-light: #f8fafc;
        }

        body {
            background: linear-gradient(135deg, var(--quantum-light) 0%, #e2e8f0 100%);
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
        }

        .quantum-header {
            background: linear-gradient(135deg, var(--quantum-primary) 0%, var(--quantum-secondary) 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
        }

        .quantum-title {
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 0.5rem;
        }

        .quantum-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }

        /* Tab styling */
        .nav-tabs .nav-link {
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin-right: 0.5rem;
            border-radius: 10px 10px 0 0;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .nav-tabs .nav-link.active {
            background: white;
            color: var(--quantum-primary);
            font-weight: 600;
        }

        .tab-content {
            background: white;
            border-radius: 0 15px 15px 15px;
            min-height: 600px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: none;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--quantum-primary);
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .article-card {
            background: white;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: none;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .article-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        /* Ontology visualization styles */
        #ontology-graph {
            width: 100%;
            height: 600px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background: #f8fafc;
        }

        .node-hardware { fill: var(--quantum-primary); }
        .node-supplier { fill: var(--quantum-accent); }
        .node-software { fill: var(--quantum-secondary); }

        .node-hardware:hover,
        .node-supplier:hover,
        .node-software:hover {
            stroke: #333;
            stroke-width: 3px;
            cursor: pointer;
        }

        .link-supplies { stroke: #94a3b8; stroke-width: 2px; }
        .link-supports { stroke: #cbd5e1; stroke-width: 1.5px; }

        .node-label {
            font-family: 'Inter', sans-serif;
            font-size: 10px;
            font-weight: 600;
            fill: #1e293b;
            text-anchor: middle;
            pointer-events: none;
        }

        .tooltip {
            position: absolute;
            text-align: left;
            padding: 12px;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 300px;
        }

        .legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .controls {
            margin: 1rem 0;
            text-align: center;
        }

        .btn-ontology {
            background: var(--quantum-primary);
            border: none;
            color: white;
            margin: 0 0.25rem;
            transition: all 0.3s ease;
        }

        .btn-ontology:hover {
            background: var(--quantum-secondary);
            color: white;
            transform: translateY(-2px);
        }

        .fade-in {
            animation: fadeIn 0.6s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="quantum-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="quantum-title">
                        <i class="bi bi-atom"></i>
                        Quantum News Hub
                    </h1>
                    <p class="quantum-subtitle">
                        <i class="bi bi-robot"></i>
                        AI-Powered News & Ecosystems Intelligence
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <!-- Navigation Tabs -->
                    <ul class="nav nav-tabs" id="mainTabs">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#news-tab">
                                <i class="bi bi-newspaper"></i> News
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#ontology-tab">
                                <i class="bi bi-diagram-3"></i> Ontology
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="tab-content" id="mainTabsContent">

            <!-- News Tab -->
            <div class="tab-pane fade show active" id="news-tab">
                <div class="p-4">
                    <!-- Statistics Section -->
                    <div class="stats-card">
                        <div class="row" id="stats-section">
                            <div class="col-md-4">
                                <div class="stat-item">
                                    <span class="stat-number" id="total-articles">-</span>
                                    <span class="stat-label">Total Articles</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-item">
                                    <span class="stat-number" id="summarized-articles">-</span>
                                    <span class="stat-label">AI Summarized</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-item">
                                    <span class="stat-number" id="pending-articles">-</span>
                                    <span class="stat-label">Pending Summary</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Articles Section -->
                    <div id="articles-container">
                        <!-- Loading state -->
                        <div class="text-center" id="news-loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading articles...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ontology Tab -->
            <div class="tab-pane fade" id="ontology-tab">
                <div class="p-4">
                    <h3 class="mb-3">
                        <i class="bi bi-diagram-3"></i>
                        Quantum Computing Ecosystems Ontology
                    </h3>
                    <p class="text-muted mb-4">
                        Interactive visualization of quantum computing companies, suppliers, and relationships.
                        Click on nodes to see detailed information.
                    </p>

                    <!-- Controls -->
                    <div class="controls">
                        <button class="btn btn-ontology btn-sm" onclick="resetZoom()">
                            <i class="bi bi-zoom-out"></i> Reset View
                        </button>
                        <button class="btn btn-ontology btn-sm" onclick="centerGraph()">
                            <i class="bi bi-bullseye"></i> Center
                        </button>
                        <button class="btn btn-ontology btn-sm" onclick="refreshOntology()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>

                    <!-- Graph Container -->
                    <div class="position-relative">
                        <div id="ontology-graph"></div>

                        <!-- Legend -->
                        <div class="legend">
                            <h6>Node Types</h6>
                            <div class="legend-item">
                                <div class="legend-color node-hardware"></div>
                                Hardware Companies
                            </div>
                            <div class="legend-item">
                                <div class="legend-color node-supplier"></div>
                                Component Suppliers
                            </div>
                            <div class="legend-item">
                                <div class="legend-color node-software"></div>
                                Software Companies
                            </div>
                        </div>

                        <!-- Loading state -->
                        <div class="text-center d-none" id="ontology-loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading ontology...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Node Details Panel -->
                    <div class="card mt-4 d-none" id="node-details">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-info-circle"></i>
                                <span id="node-title">Node Details</span>
                            </h5>
                        </div>
                        <div class="card-body" id="node-details-content">
                            <!-- Details will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip for ontology -->
    <div class="tooltip" id="tooltip"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables
        let ontologyData = null;
        let svg = null;
        let simulation = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load news data initially
            loadNewsData();

            // Auto-refresh news every 5 minutes
            setInterval(loadNewsData, 5 * 60 * 1000);

            // Load ontology when tab is first clicked
            document.querySelector('a[href="#ontology-tab"]').addEventListener('click', function() {
                if (!ontologyData) {
                    loadOntologyData();
                }
            });
        });

        // News Functions
        async function loadNewsData() {
            try {
                const [statsResponse, articlesResponse] = await Promise.all([
                    fetch('/api/stats'),
                    fetch('/api/articles')
                ]);

                const stats = await statsResponse.json();
                const articles = await articlesResponse.json();

                if (stats.status === 'success') {
                    updateStatsDisplay(stats.stats);
                }

                if (articles.status === 'success') {
                    displayArticles(articles.articles);
                }
            } catch (error) {
                console.error('Error loading news data:', error);
            }
        }

        function updateStatsDisplay(stats) {
            document.getElementById('total-articles').textContent = stats.total_articles || 0;
            document.getElementById('summarized-articles').textContent = stats.articles_with_summary || 0;
            document.getElementById('pending-articles').textContent = stats.articles_without_summary || 0;
        }

        function displayArticles(articles) {
            const container = document.getElementById('articles-container');
            const loading = document.getElementById('news-loading');

            loading.style.display = 'none';

            if (articles.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 3rem; color: #94a3b8;"></i>
                        <h4 class="mt-3">No Articles Yet</h4>
                        <p class="text-muted">Articles with AI summaries will appear here once processed.</p>
                    </div>
                `;
                return;
            }

            const articlesHtml = articles.map(article => `
                <div class="article-card fade-in">
                    <div class="card-body">
                        <h5 class="card-title">${escapeHtml(article.title)}</h5>
                        <div class="d-flex flex-wrap gap-3 mb-3 text-muted small">
                            <span><i class="bi bi-person"></i> ${escapeHtml(article.author)}</span>
                            <span><i class="bi bi-calendar"></i> ${formatDate(article.publish_date)}</span>
                        </div>
                        <p class="card-text">${escapeHtml(article.summary)}</p>
                        <a href="${escapeHtml(article.link)}" class="btn btn-primary" target="_blank" rel="noopener">
                            <i class="bi bi-arrow-up-right"></i> Read Original
                        </a>
                    </div>
                </div>
            `).join('');

            container.innerHTML = articlesHtml;
        }

        // Ontology Functions
        async function loadOntologyData() {
            const loading = document.getElementById('ontology-loading');
            const graphContainer = document.getElementById('ontology-graph');

            loading.classList.remove('d-none');

            try {
                const response = await fetch('/api/ontology/graph');
                const result = await response.json();

                if (result.status === 'success') {
                    ontologyData = result.data;
                    createOntologyVisualization();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error loading ontology:', error);
                graphContainer.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: #ef4444;"></i>
                        <h4 class="mt-3">Failed to Load Ontology</h4>
                        <p class="text-muted">${error.message}</p>
                        <button class="btn btn-primary" onclick="loadOntologyData()">Try Again</button>
                    </div>
                `;
            } finally {
                loading.classList.add('d-none');
            }
        }

        function createOntologyVisualization() {
            const container = d3.select("#ontology-graph");
            container.selectAll("*").remove();

            const width = container.node().clientWidth;
            const height = 600;

            svg = container.append("svg")
                .attr("width", width)
                .attr("height", height);

            const g = svg.append("g");

            // Zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on("zoom", (event) => {
                    g.attr("transform", event.transform);
                });

            svg.call(zoom);

            // Create simulation
            simulation = d3.forceSimulation(ontologyData.nodes)
                .force("link", d3.forceLink(ontologyData.links).id(d => d.id).distance(100))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("center", d3.forceCenter(width / 2, height / 2));

            // Create links
            const link = g.append("g")
                .selectAll("line")
                .data(ontologyData.links)
                .join("line")
                .attr("class", d => `link-${d.type}`)
                .attr("stroke-opacity", 0.6);

            // Create nodes
            const node = g.append("g")
                .selectAll("circle")
                .data(ontologyData.nodes)
                .join("circle")
                .attr("r", 8)
                .attr("class", d => `node-${d.type}`)
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended))
                .on("click", handleNodeClick)
                .on("mouseover", showTooltip)
                .on("mouseout", hideTooltip);

            // Create labels
            const label = g.append("g")
                .selectAll("text")
                .data(ontologyData.nodes)
                .join("text")
                .attr("class", "node-label")
                .attr("dy", "0.35em")
                .text(d => d.name.length > 15 ? d.name.substring(0, 12) + "..." : d.name);

            // Update simulation
            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);

                label
                    .attr("x", d => d.x)
                    .attr("y", d => d.y + 20);
            });

            // Store references for controls
            window.ontologyZoom = zoom;
            window.ontologySvg = svg;
        }

        // Node interaction functions
        function handleNodeClick(event, d) {
            showNodeDetails(d);

            // Highlight connected nodes
            highlightConnectedNodes(d);
        }

        async function showNodeDetails(node) {
            const detailsPanel = document.getElementById('node-details');
            const titleElement = document.getElementById('node-title');
            const contentElement = document.getElementById('node-details-content');

            titleElement.textContent = node.name;
            contentElement.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Loading...';
            detailsPanel.classList.remove('d-none');

            try {
                const response = await fetch(`/api/ontology/node/${encodeURIComponent(node.id)}`);
                const result = await response.json();

                if (result.status === 'success') {
                    displayNodeDetails(result.details);
                } else {
                    contentElement.innerHTML = '<p class="text-danger">Failed to load details</p>';
                }
            } catch (error) {
                contentElement.innerHTML = '<p class="text-danger">Error loading details</p>';
            }
        }

        function displayNodeDetails(details) {
            const contentElement = document.getElementById('node-details-content');

            const detailsHtml = Object.entries(details)
                .filter(([key, value]) => key !== 'name' && value && value !== 'nan')
                .map(([key, value]) => {
                    const displayKey = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    let displayValue = value;

                    // Format URLs as links
                    if (key.includes('website') || key.includes('url') || value.toString().startsWith('http')) {
                        displayValue = `<a href="${value}" target="_blank" rel="noopener">${value}</a>`;
                    }

                    return `
                        <div class="row mb-2">
                            <div class="col-4 fw-bold">${displayKey}:</div>
                            <div class="col-8">${displayValue}</div>
                        </div>
                    `;
                })
                .join('');

            contentElement.innerHTML = detailsHtml || '<p class="text-muted">No additional details available</p>';
        }

        function highlightConnectedNodes(centerNode) {
            // Reset all nodes
            d3.selectAll("circle").style("opacity", 0.3);
            d3.selectAll("line").style("opacity", 0.1);

            // Highlight center node
            d3.selectAll("circle").filter(d => d.id === centerNode.id).style("opacity", 1);

            // Highlight connected nodes and links
            ontologyData.links.forEach(link => {
                if (link.source.id === centerNode.id || link.target.id === centerNode.id) {
                    d3.selectAll("circle").filter(d =>
                        d.id === link.source.id || d.id === link.target.id
                    ).style("opacity", 1);

                    d3.selectAll("line").filter(d =>
                        (d.source.id === link.source.id && d.target.id === link.target.id)
                    ).style("opacity", 0.8);
                }
            });

            // Reset after 3 seconds
            setTimeout(() => {
                d3.selectAll("circle").style("opacity", 1);
                d3.selectAll("line").style("opacity", 0.6);
            }, 3000);
        }

        // Tooltip functions
        function showTooltip(event, d) {
            const tooltip = d3.select("#tooltip");
            tooltip.transition().duration(200).style("opacity", .9);
            tooltip.html(`
                <strong>${d.name}</strong><br/>
                Type: ${d.type.charAt(0).toUpperCase() + d.type.slice(1)}<br/>
                ${d.details.country ? `Country: ${d.details.country}<br/>` : ''}
                Click for more details
            `)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 28) + "px");
        }

        function hideTooltip() {
            d3.select("#tooltip").transition().duration(500).style("opacity", 0);
        }

        // Drag functions
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Control functions
        function resetZoom() {
            if (window.ontologySvg && window.ontologyZoom) {
                window.ontologySvg.transition().duration(750)
                    .call(window.ontologyZoom.transform, d3.zoomIdentity);
            }
        }

        function centerGraph() {
            if (simulation) {
                const width = document.getElementById('ontology-graph').clientWidth;
                const height = 600;
                simulation.force("center", d3.forceCenter(width / 2, height / 2));
                simulation.alpha(0.3).restart();
            }
        }

        function refreshOntology() {
            ontologyData = null;
            loadOntologyData();
        }

        // Utility functions
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }
    </script>
</body>
</html>